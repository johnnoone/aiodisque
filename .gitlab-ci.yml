---

stages:
  - build
  - test
  - release

Prepare container:
  stage: build
  script:
    - docker build -t errorist/aiodisque:latest .
  tags:
    - docker-build

Test:
  stage: test
  image: errorist/aiodisque:latest
  script:
    - python -m pip install -e .
    - python -m pip install -r requirements-test.txt
    - py.test tests/ --cov aiodisque --cov-report term-missing --flake8 -m "not curio"
  tags:
    - python3.5

Test curio:
  stage: test
  image: errorist/aiodisque:latest
  script:
    - python -m pip install -e .
    - python -m pip install -r requirements-test.txt
    - py.test tests/ --cov aiodisque --cov-report term-missing --flake8 -m curio
  tags:
    - python3.5
  allow_failure: true

Release to pypi:
  stage: release
  image: errorist/aiodisque:latest
  script:
    - python setup.py sdist bdist_wheel
    - twine upload -u $PYPI_USER -p $PYPI_PASSWORD dist/*
  tags:
    - python3.5
  only:
    - /^v[\d\.]+.*$/
  allow_failure: true

Upload documentation:
  stage: release
  image: errorist/aiodisque:latest
  script:
    - curl -X POST http://readthedocs.org/build/aio-disque
  tags:
    - python3.5
  only:
    - master
  allow_failure: true
