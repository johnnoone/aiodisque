FROM ubuntu:latest
MAINTAINER Xavier Barbosa <clint.northwood@gmail.com>

RUN apt-get -y update && \
    apt-get -y install build-essential curl tar
MOUNT .:/app
RUN curl -LO https://github.com/antirez/disque/archive/1.0-rc1.tar.gz
RUN tar zxvf 1.0-rc1.tar.gz
RUN cd disque-1.0-rc1 && make && \
    mv src/disque /app/ && \
    mv src/disque-server /app/disque-server && \
    mv disque.conf /app/disque.conf

FROM errorist/py:3.5
MAINTAINER Xavier Barbosa <clint.northwood@gmail.com>

ENV DISQUE_PORT 7711
RUN mkdir -p /usr/local/bin
ADD disque /usr/local/bin/disque
ADD disque-server /usr/local/bin/disque-server
ADD disque.conf /etc/disque.conf
RUN chmod +x /usr/local/bin/disque
RUN chmod +x /usr/local/bin/disque-server

RUN apk add --no-cache gcc python3-dev
RUN python -m pip install hiredis
MOUNT /app
TAG errorist/aiodisque:latest

CMD ["/usr/local/bin/disque-server", "/etc/disque.conf", "--port", "$DISQUE_PORT"]
